<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CineNovaTv</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .filters { display: flex; justify-content: center; gap: 1rem; margin: 1rem auto; flex-wrap: wrap; }
    .filters select, .filters button {
      background: #111;
      color: white;
      border: 1px solid #10b981;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    .filters button.active {
      background: #10b981;
      color: black;
      font-weight: bold;
    }
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%;
      height: 100%; background: rgba(0,0,0,0.8); justify-content: center;
      align-items: center; z-index: 1000;
    }
    .modal-content {
      background: #000; padding: 1rem; max-width: 800px;
      width: 90%; position: relative;
    }
    .modal iframe {
      width: 100%; height: 400px;
    }
    .close-btn {
      position: absolute; top: 10px; right: 15px;
      background: #e50914; color: #fff; border: none;
      padding: 0.3rem 0.6rem; cursor: pointer;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>

  <header>
    <h1>CineNovaTv</h1>
    <input type="text" id="searchBar" placeholder="Search films..." />
  </header>

  <div class="filters">
    <button id="todayBtn" class="active">Today</button>
    <button id="weekBtn">This Week</button>
    <select id="genreSelect">
      <option value="">All Genres</option>
    </select>
  </div>

  <main class="main-content">
    <section class="film-grid" id="filmGrid"></section>
    <div style="text-align:center; margin: 2rem;">
      <button id="loadMoreBtn">Load More</button>
    </div>
  </main>

  <footer class="footer">
    &copy; 2025 CineCinema. This product uses the TMDB API but is not endorsed or certified by TMDB.
    <br />
    <a href="https://www.themoviedb.org/" target="_blank" style="color:#10b981;">Visit TMDB</a>
  </footer>

  <!-- Trailer Modal -->
  <div class="modal" id="trailerModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeTrailer()">Ã—</button>
      <iframe id="trailerFrame" src="" frameborder="0" allowfullscreen></iframe>
    </div>
  </div>

<script>
  const genreSelect = document.getElementById('genreSelect');
  const filmGrid = document.getElementById('filmGrid');
  const todayBtn = document.getElementById('todayBtn');
  const weekBtn = document.getElementById('weekBtn');
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  const searchBar = document.getElementById('searchBar');
  const trailerModal = document.getElementById('trailerModal');
  const trailerFrame = document.getElementById('trailerFrame');

  let currentPage = 1;
  let currentTime = 'day';
  let currentGenre = '';
  let searchQuery = '';

  async function loadGenres() {
    const res = await fetch('/api/genres');
    const data = await res.json();
    data.genres.forEach(genre => {
      const opt = document.createElement('option');
      opt.value = genre.id;
      opt.textContent = genre.name;
      genreSelect.appendChild(opt);
    });
  }

  async function loadMovies() {
    loadMoreBtn.disabled = true;
    let url = `/api/trending/${currentTime}?page=${currentPage}`;
    if (searchQuery.length > 1) {
      url = `/api/search?query=${encodeURIComponent(searchQuery)}&page=${currentPage}`;
    }

    const res = await fetch(url);
    const data = await res.json();

    // Filter by genre if selected
    const filtered = currentGenre
      ? data.results.filter(m => m.genre_ids.includes(parseInt(currentGenre)))
      : data.results;

    filtered.forEach(movie => {
      const poster = movie.poster_path ? `https://image.tmdb.org/t/p/w500${movie.poster_path}` : 'placeholder.jpg';
      const card = document.createElement('div');
      card.className = 'film-item';
      card.innerHTML = `
        <img class="film-poster" src="${poster}" alt="${movie.title}">
        <h3>${movie.title}</h3>
        <p>${movie.overview ? movie.overview.slice(0, 100) : ''}...</p>
        <button onclick="showTrailer(${movie.id})" class="read-more">Watch Trailer</button>
      `;
      filmGrid.appendChild(card);
    });

    loadMoreBtn.disabled = false;
  }

  function showTrailer(movieId) {
    fetch(`/api/movie/${movieId}/trailer`)
      .then(res => res.json())
      .then(data => {
        console.log('Trailer data:', data);
        const trailer = data.results.find(v => 
          v.site === 'YouTube' && 
          (v.type === 'Trailer' || v.type === 'Teaser' || v.type === 'Clip')
        );
        if (trailer) {
          trailerFrame.src = `https://www.youtube.com/embed/${trailer.key}`;
          trailerModal.style.display = 'flex';
        } else {
          alert('Trailer not available');
        }
      })
      .catch(err => {
        console.error('Error fetching trailer:', err);
        alert('Failed to load trailer');
      });
  }

  function closeTrailer() {
    trailerFrame.src = '';
    trailerModal.style.display = 'none';
  }

  // Event handlers
  todayBtn.onclick = () => {
    currentTime = 'day';
    currentPage = 1;
    todayBtn.classList.add('active');
    weekBtn.classList.remove('active');
    filmGrid.innerHTML = '';
    loadMovies();
  };

  weekBtn.onclick = () => {
    currentTime = 'week';
    currentPage = 1;
    weekBtn.classList.add('active');
    todayBtn.classList.remove('active');
    filmGrid.innerHTML = '';
    loadMovies();
  };

  genreSelect.onchange = () => {
    currentGenre = genreSelect.value;
    currentPage = 1;
    filmGrid.innerHTML = '';
    loadMovies();
  };

  searchBar.addEventListener('input', () => {
    searchQuery = searchBar.value.trim();
    currentPage = 1;
    filmGrid.innerHTML = '';
    loadMovies();
  });

  loadMoreBtn.onclick = () => {
    currentPage++;
    loadMovies();
  };

  // Initial load
  loadGenres();
  loadMovies();
</script>
</body>
</html>
